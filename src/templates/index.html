<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini-RAG Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Outfit', sans-serif; background: #f8fafc; color: #1e293b; }
    .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
    .btn-gradient { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); transition: all 0.3s ease; }
    .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
    .loader-dots div { animation-timing-function: cubic-bezier(0, 1, 1, 0); }
    .loader-dots div:nth-child(1) { left: 8px; animation: loader-dots1 0.6s infinite; }
    .loader-dots div:nth-child(2) { left: 8px; animation: loader-dots2 0.6s infinite; }
    .loader-dots div:nth-child(3) { left: 32px; animation: loader-dots2 0.6s infinite; }
    .loader-dots div:nth-child(4) { left: 56px; animation: loader-dots3 0.6s infinite; }
    @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    @keyframes loader-dots3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
    @keyframes loader-dots2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }
</style>
</head>
<body class="p-4 md:p-12">

<div class="max-w-4xl mx-auto">
    <header class="text-center mb-12">
        <h1 class="text-5xl font-bold mb-3 bg-clip-text text-transparent gradient-bg">Mini-RAG Dashboard</h1>
        <p class="text-slate-500 text-lg">Manage your project files, processing, and RAG queries with style.</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <!-- Project Config -->
        <div class="bg-white p-6 rounded-2xl shadow-xl glass-card col-span-full">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 gradient-bg rounded-lg text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                </div>
                <h2 class="text-xl font-bold">Project Configuration</h2>
            </div>
            <div class="relative">
                <input type="text" id="globalId" placeholder="Project ID (e.g., 2002)" class="text-lg w-full border-2 border-slate-100 rounded-xl px-5 py-3 focus:border-indigo-500 outline-none transition-all">
                <span class="absolute right-4 top-4 text-slate-400 text-sm">Required for all actions</span>
            </div>
        </div>

        <!-- Section 1: Upload -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 transition-all hover:shadow-xl">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm">1</span>
                Upload Data
            </h3>
            <div class="space-y-4">
                <div class="relative group">
                    <input type="file" id="uploadFile" class="hidden">
                    <label for="uploadFile" class="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-xl p-8 cursor-pointer group-hover:border-indigo-400 transition-all">
                        <svg class="w-10 h-10 text-slate-300 group-hover:text-indigo-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span id="fileNameDisplay" class="text-slate-500 group-hover:text-indigo-600 font-medium">Click to select file</span>
                    </label>
                </div>
                <button onclick="uploadData()" class="w-full btn-gradient text-white font-bold py-3 px-6 rounded-xl">Start Upload</button>
                <div id="uploadStatus" class="hidden">
                    <div class="flex items-center gap-3 p-3 bg-indigo-50 text-indigo-700 rounded-lg">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-indigo-700 border-t-transparent"></div>
                        <span class="font-medium">Uploading your file...</span>
                    </div>
                </div>
                <div id="uploadResult" class="mt-2 text-sm"></div>
            </div>
        </div>

        <!-- Section 2: Process -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 transition-all hover:shadow-xl">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-sm">2</span>
                Process & Push
            </h3>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold px-1">Chunk Size</label>
                    <input type="number" id="chunkSize" value="100" class="w-full border-b-2 border-slate-50 p-2 focus:border-purple-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold px-1">Overlap</label>
                    <input type="number" id="overlapSize" value="20" class="w-full border-b-2 border-slate-50 p-2 focus:border-purple-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold px-1">Do Reset</label>
                    <input type="number" id="doRest" value="1" min="0" max="1" class="w-full border-b-2 border-slate-50 p-2 focus:border-purple-500 outline-none" title="1 to clear collection before push, 0 to append">
                </div>
            </div>
            <button onclick="processAndPush()" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3 px-6 rounded-xl transition-all">Execute Workflow</button>
            <div id="processStatus" class="hidden mt-4">
                <div class="flex items-center gap-3 p-3 bg-purple-50 text-purple-700 rounded-lg">
                    <div class="animate-pulse w-3 h-3 bg-purple-600 rounded-full"></div>
                    <span class="font-medium">Triggering processing...</span>
                </div>
            </div>
            <div id="processResult" class="mt-2 text-sm"></div>
        </div>

        <!-- Section 3: Info & Search -->
        <div class="bg-white p-6 rounded-2xl shadow-lg col-span-full">
            <div class="flex border-b mb-6">
                <button onclick="switchTab('info')" id="tab-info" class="px-6 py-2 font-bold border-b-2 border-indigo-500 text-indigo-600">Index Info</button>
                <button onclick="switchTab('search')" id="tab-search" class="px-6 py-2 font-bold text-slate-400">Search</button>
                <button onclick="switchTab('answer')" id="tab-answer" class="px-6 py-2 font-bold text-slate-400">Ask AI</button>
            </div>

            <div id="panel-info" class="space-y-4">
                <button onclick="getIndexInfo()" class="border-2 border-slate-100 px-6 py-2 rounded-lg font-semibold hover:bg-slate-50 transition-all">Get Latest Info</button>
                <div id="infoResult" class="mt-4 overflow-hidden rounded-xl"></div>
            </div>

            <div id="panel-search" class="hidden space-y-4">
                <div class="flex gap-4">
                    <input type="text" id="searchText" placeholder="Search for something..." class="flex-1 bg-slate-50 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-indigo-100">
                    <input type="number" id="searchLimit" value="3" class="w-20 bg-slate-50 rounded-xl px-4 py-2 outline-none">
                    <button onclick="indexSearch()" class="btn-gradient text-white px-8 py-2 rounded-xl">Find</button>
                </div>
                <div id="searchResult" class="space-y-3"></div>
            </div>

            <div id="panel-answer" class="hidden flex flex-col h-[500px]">
                <!-- Chat Messages Area -->
                <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 space-y-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="flex justify-start">
                        <div class="bg-indigo-100 text-indigo-800 p-3 rounded-2xl rounded-tl-none max-w-[80%] text-sm shadow-sm">
                            Hello! I can help answering questions based on your documents. Please upload and process them first!
                        </div>
                    </div>
                </div>

                <!-- Chat Input Area -->
                <div class="relative bg-white pt-2">
                    <div class="flex gap-2">
                        <input type="text" id="answerText" placeholder="Ask a follow-up question..." 
                               class="flex-1 bg-slate-50 rounded-xl px-5 py-3 outline-none focus:ring-2 ring-indigo-100 transition-all text-sm"
                               onkeypress="if(event.key === 'Enter') indexAnswer()">
                        <button onclick="indexAnswer()" id="sendBtn" class="btn-gradient text-white px-6 py-2 rounded-xl flex items-center gap-2">
                            <span>Send</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const apiBase = 'http://127.0.0.1:8000';

document.getElementById('uploadFile').addEventListener('change', e => {
    const name = e.target.files[0]?.name || 'Click to select file';
    document.getElementById('fileNameDisplay').textContent = name;
});

function switchTab(tab) {
    const tabs = ['info', 'search', 'answer'];
    tabs.forEach(t => {
        document.getElementById(`panel-${t}`).classList.add('hidden');
        document.getElementById(`tab-${t}`).classList.remove('border-indigo-500', 'text-indigo-600');
        document.getElementById(`tab-${t}`).classList.add('text-slate-400');
    });
    document.getElementById(`panel-${tab}`).classList.remove('hidden');
    document.getElementById(`tab-${tab}`).classList.add('border-indigo-500', 'text-indigo-600');
    document.getElementById(`tab-${tab}`).classList.remove('text-slate-400');
}

function getGlobalId() {
    const id = document.getElementById('globalId').value.trim();
    if(!id) {
        shake(document.getElementById('globalId'));
        return null;
    }
    return id;
}

function shake(el) {
    el.classList.add('animate-bounce');
    setTimeout(() => el.classList.remove('animate-bounce'), 500);
}

function notify(divId, message, type='success') {
    const colors = {
        'success': 'bg-green-50 text-green-700 border-green-200',
        'error': 'bg-red-50 text-red-700 border-red-200',
        'info': 'bg-blue-50 text-blue-700 border-blue-200'
    };
    const icons = {
        'success': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
        'error': 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z',
        'info': 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
    };
    
    document.getElementById(divId).innerHTML = `
        <div class="flex items-start gap-3 p-4 rounded-xl border ${colors[type]} mb-4 animate-[fadeIn_0.3s_ease]">
            <svg class="w-5 h-5 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icons[type]}"></path></svg>
            <p class="text-sm font-medium leading-relaxed">${message}</p>
        </div>
    `;
}

let lastFileId = null;

async function uploadData() {
    const id = getGlobalId();
    if(!id) return;
    const fileInput = document.getElementById('uploadFile');
    if(!fileInput.files.length) return notify('uploadResult', 'Please select a file first', 'error');

    document.getElementById('uploadStatus').classList.remove('hidden');
    document.getElementById('uploadResult').innerHTML = '';

    try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        const res = await fetch(`${apiBase}/api/v1/data/upload/${id}`, { method:'POST', body: formData });
        const data = await res.json();
        
        if(res.ok) {
            lastFileId = data.file_id;
            notify('uploadResult', `Success! File ID: ${data.file_id || 'N/A'}`, 'success');
        } else {
            notify('uploadResult', `Upload failed: ${data.detail || data.signal || JSON.stringify(data)}`, 'error');
        }
    } catch(e) {
        notify('uploadResult', `Error connecting to server. Is the API running?`, 'error');
    } finally {
        document.getElementById('uploadStatus').classList.add('hidden');
    }
}

async function processAndPush() {
    const id = getGlobalId();
    if(!id) return;

    document.getElementById('processStatus').classList.remove('hidden');
    document.getElementById('processResult').innerHTML = '';

    try {
        const payload = {
            chunk_size: Number(document.getElementById('chunkSize').value),
            overlap_size: Number(document.getElementById('overlapSize').value),
            do_reset: Number(document.getElementById('doRest')?.value || 1),
            file_id: lastFileId
        };
        const res = await fetch(`${apiBase}/api/v1/data/process-and-push/${id}`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if(res.ok) {
            notify('processResult', `Workflow started! Task: ${data.workflow_task_id}`, 'success');
        } else {
            notify('processResult', `Failed: ${res.statusText} (${res.status}). Verify project ID exists.`, 'error');
        }
    } catch(e) {
        notify('processResult', `Network error. CORS might be blocking the preflight OPTIONS request if the server wasn't restarted.`, 'error');
    } finally {
        document.getElementById('processStatus').classList.add('hidden');
    }
}

async function getIndexInfo() {
    const id = getGlobalId();
    if(!id) return;
    document.getElementById('infoResult').innerHTML = '<div class="p-4 text-slate-400">Loading info...</div>';
    
    try {
        const res = await fetch(`${apiBase}/api/v1/nlp/index/info/${id}`);
        const data = await res.json();
        if(res.ok && data.collection_info) {
            const table = data.collection_info.table_info;
            document.getElementById('infoResult').innerHTML = `
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="text-xs text-slate-400 uppercase block">Database Table</span><span class="font-mono font-bold">${table.tablename}</span></div>
                        <div><span class="text-xs text-slate-400 uppercase block">Records Found</span><span class="font-mono font-bold text-indigo-600">${data.collection_info.record_count}</span></div>
                    </div>
                </div>
            `;
        } else {
            notify('infoResult', data.detail || 'Collection not found or project ID invalid', 'error');
        }
    } catch(e) { notify('infoResult', 'Could not reach server', 'error'); }
}

async function indexSearch() {
    const id = getGlobalId();
    if(!id) return;
    const text = document.getElementById('searchText').value;
    if(!text) return;

    document.getElementById('searchResult').innerHTML = '<div class="animate-pulse flex space-x-4 p-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-slate-200 rounded w-3/4"></div><div class="h-4 bg-slate-200 rounded"></div></div></div>';

    try {
        const res = await fetch(`${apiBase}/api/v1/nlp/index/search/${id}`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text, limit: Number(document.getElementById('searchLimit').value) })
        });
        const data = await res.json();
        if(res.ok && data.results) {
            document.getElementById('searchResult').innerHTML = data.results.map(r => `
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 h-full">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] bg-indigo-500 text-white px-2 py-0.5 rounded-full font-bold">MATCH: ${(r.score * 100).toFixed(1)}%</span>
                    </div>
                    <p class="text-sm text-slate-700 leading-relaxed">${r.text}</p>
                </div>
            `).join('');
        } else notify('searchResult', 'Search failed', 'error');
    } catch(e) { notify('searchResult', 'Connection error', 'error'); }
}

let currentChatHistory = [];

function formatMarkdown(text) {
    // Basic Markdown conversion
    return text
        // Headers
        .replace(/^### (.*$)/gim, '<h3 class="font-bold text-lg mt-2 mb-1">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 class="font-bold text-xl mt-3 mb-2">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 class="font-bold text-2xl mt-4 mb-3">$1</h1>')
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-900">$1</strong>')
        // New lines
        .replace(/\n/g, '<br>');
}

function appendChatMessage(text, isUser = false) {
    const chatArea = document.getElementById('chatMessages');
    const wrapper = document.createElement('div');
    wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4 animate-[fadeIn_0.2s_ease]`;
    
    const bubble = document.createElement('div');
    bubble.className = isUser 
        ? 'bg-slate-900 text-white p-3 rounded-2xl rounded-tr-none max-w-[80%] text-sm shadow-md'
        : 'bg-indigo-50 text-slate-800 p-4 rounded-2xl rounded-tl-none max-w-[80%] text-sm shadow-sm border border-indigo-100 leading-relaxed';
    
    if (isUser) {
        bubble.textContent = text;
    } else {
        bubble.innerHTML = formatMarkdown(text);
    }
    
    wrapper.appendChild(bubble);
    chatArea.appendChild(wrapper);
    chatArea.scrollTop = chatArea.scrollHeight;
}

async function indexAnswer() {
    const id = getGlobalId();
    if(!id) return;
    
    const inputEl = document.getElementById('answerText');
    const text = inputEl.value.trim();
    if(!text) return;

    // 1. Show user message
    inputEl.value = '';
    appendChatMessage(text, true);

    // 2. Add loading indicator
    const loadingId = 'loading-' + Date.now();
    const chatArea = document.getElementById('chatMessages');
    const loader = document.createElement('div');
    loader.id = loadingId;
    loader.className = 'flex justify-start mb-4';
    loader.innerHTML = `
        <div class="bg-indigo-50 text-indigo-400 p-3 rounded-2xl rounded-tl-none flex gap-2 items-center">
            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></div>
            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce [animation-delay:0.4s]"></div>
        </div>
    `;
    chatArea.appendChild(loader);
    chatArea.scrollTop = chatArea.scrollHeight;

    try {
        const res = await fetch(`${apiBase}/api/v1/nlp/index/answer/${id}`, {
            method:'POST', 
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ 
                text, 
                limit: 6,
                chat_history: currentChatHistory 
            })
        });
        const data = await res.json();
        
        // Remove loader
        document.getElementById(loadingId).remove();

        if(res.ok && data.answer) {
            appendChatMessage(data.answer, false);
            // Save the history returned from backend
            currentChatHistory = data.chat_history;
        } else {
            appendChatMessage("Error: " + (data.detail || "Failed to get response"), false);
        }
    } catch(e) {
        document.getElementById(loadingId).remove();
        appendChatMessage("Network error. Please try again.", false);
    }
}
</script>

<style>
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

</body>
</html>
